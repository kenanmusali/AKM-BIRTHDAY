<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birthday Post Generator</title>
    <link rel="stylesheet" href="./common/css/root.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap" rel="stylesheet">
</head>

<body>
    <div class="control-panel">
        <div class="control-group">
            <label for="excelFile">Excel File</label>
            <input type="file" id="excelFile" accept=".xlsx, .xls">
            
            <p>or Choose from the list</p>

            <div class="excel-file-list" id="excelFileList">
                Loading available Excel files...
            </div>
        </div>
        <div class="control-group upload">
            <label for="excelFileUpload">Upload Excel File</label>
            <input type="file" id="excelFileUpload" accept=".xlsx, .xls">

        </div>
        <div class="control-group upload">
            <button onclick="uploadExcelFile()">Upload to List</button>
            <div id="uploadStatus"></div>
        </div>

        <div class="control-group">
            <label for="datePicker">Birthday Date</label>
            <input type="text" id="datePicker" placeholder="DD/MM">
        </div>
        <button id="processBtn">Generate Birthday Post</button>
    </div>

    <div id="resultContainer"></div>

    <script>
async function uploadExcelFile() {
    const fileInput = document.getElementById('excelFileUpload');
    const uploadStatus = document.getElementById('uploadStatus');
    
    if (!fileInput.files?.length) {
        uploadStatus.textContent = 'Please select a file first';
        uploadStatus.style.color = 'red';
        return;
    }

    const file = fileInput.files[0];
    
    try {
        uploadStatus.textContent = 'Preparing upload...';
        uploadStatus.style.color = 'black';

        // 1. Get signed upload URL
        const response = await fetch('/api/get-upload-url', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                fileName: file.name,
                fileType: file.type || 'application/octet-stream',
                folderPath: 'docs/'
            })
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error || 'Failed to get upload URL');
        }

        const { uploadUrl, filePath } = await response.json();

        // 2. Upload file directly to Blob storage
        uploadStatus.textContent = 'Uploading file...';
        
        // Read file as ArrayBuffer
        const fileBuffer = await file.arrayBuffer();
        
        const uploadResponse = await fetch(uploadUrl, {
            method: 'PUT',
            body: fileBuffer,
            headers: {
                'Content-Type': file.type || 'application/octet-stream',
                'x-vercel-digest': await calculateDigest(fileBuffer) // Important!
            },
        });

        if (!uploadResponse.ok) {
            throw new Error(`Upload failed with status ${uploadResponse.status}`);
        }

        // 3. Confirm upload in your system
        uploadStatus.textContent = 'Finalizing...';
        const confirmResponse = await fetch('/api/confirm-upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                filePath,
                fileName: file.name,
                size: file.size,
                type: file.type
            })
        });

        if (!confirmResponse.ok) {
            throw new Error('Failed to confirm upload');
        }

        uploadStatus.textContent = 'File uploaded successfully!';
        uploadStatus.style.color = 'green';
        loadExcelFiles();

    } catch (error) {
        uploadStatus.textContent = `Error: ${error.message}`;
        uploadStatus.style.color = 'red';
        console.error('Upload failed:', error);
    }
}

// Helper function to calculate SHA-1 digest
async function calculateDigest(buffer) {
    const hashBuffer = await crypto.subtle.digest('SHA-1', buffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}
   
   
   </script>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="./common/js/fixTurkishCharacters.js"></script>
    <script src="./common/js/transformDepartment.js"></script>
    <script src="./common/js/createAnniversarySelector.js"></script>
    <script src="./common/js/generateFinalImage.js"></script>
    <script src="./common/js/createTextPositionControls.js"></script>
    <script src="./common/js/createPositionControls.js"></script>
    <script src="./common/js/loadImage.js"></script>
    <script src="./common/js/processExcel.js"></script>
    <script src="./common/js/loadExcelFiles.js"></script>
    <script src="./common/js/processExcelFromBuffer.js"></script>
    <script src="./common/js/processExcelData.js"></script>
</body>

</html>