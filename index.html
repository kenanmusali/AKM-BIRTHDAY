<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birthday Post Generator</title>
    <link rel="stylesheet" href="./common/css/root.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap" rel="stylesheet">
</head>

<body>
    <div class="control-panel">
        <div class="control-group">
            <label for="excelFile">Excel File</label>
            <input type="file" id="excelFile" accept=".xlsx, .xls">
            
            <p>or Choose from the list</p>

            <div class="excel-file-list" id="excelFileList">
                Loading available Excel files...
            </div>
        </div>
        <div class="control-group">
            <label for="excelFileUpload">Upload Excel File</label>
            <input type="file" id="excelFileUpload" accept=".xlsx, .xls">

        </div>
        <div class="control-group">
            <button onclick="uploadExcelFile()">Upload to List</button>
            <div id="uploadStatus"></div>
        </div>

        <div class="control-group">
            <label for="datePicker">Birthday Date</label>
            <input type="text" id="datePicker" placeholder="DD/MM">
        </div>
        <button id="processBtn">Generate Birthday Post</button>
    </div>

    <div id="resultContainer"></div>

    <script>
async function uploadExcelFile() {
    const fileInput = document.getElementById('excelFileUpload');
    const uploadStatus = document.getElementById('uploadStatus');
    
    if (!fileInput.files || fileInput.files.length === 0) {
        uploadStatus.textContent = 'Please select a file first';
        uploadStatus.style.color = 'red';
        return;
    }

    const file = fileInput.files[0];
    const folderPath = 'docs/'; // Changed from assets/docs/ to just docs/
    
    try {
        uploadStatus.textContent = 'Preparing upload...';
        uploadStatus.style.color = 'black';

        // 1. First get the upload URL
        const uploadUrlResponse = await fetch('/api/get-upload-url', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                fileName: file.name,
                fileType: file.type,
                folderPath: folderPath
            })
        });

        // Add proper error handling for the response
        if (!uploadUrlResponse.ok) {
            const errorText = await uploadUrlResponse.text();
            throw new Error(`Server error: ${errorText}`);
        }

        const { url, filePath } = await uploadUrlResponse.json();

        // 2. Upload the file to the obtained URL
        uploadStatus.textContent = 'Uploading file...';
        const uploadResponse = await fetch(url, {
            method: 'PUT',
            body: file,
            headers: {
                'Content-Type': file.type,
            },
        });

        if (!uploadResponse.ok) {
            throw new Error('File upload to storage failed');
        }

        // 3. Confirm the upload
        uploadStatus.textContent = 'Finalizing...';
        const dbResponse = await fetch('/api/confirm-upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                filePath,
                fileName: file.name,
                size: file.size,
                type: file.type
            })
        });

        if (!dbResponse.ok) {
            const errorText = await dbResponse.text();
            throw new Error(`Database error: ${errorText}`);
        }

        uploadStatus.textContent = 'File uploaded successfully!';
        uploadStatus.style.color = 'green';
        loadExcelFiles();
        
    } catch (error) {
        uploadStatus.textContent = `Error: ${error.message}`;
        uploadStatus.style.color = 'red';
        console.error('Full upload error:', error);
    }
}
    </script>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="./common/js/fixTurkishCharacters.js"></script>
    <script src="./common/js/transformDepartment.js"></script>
    <script src="./common/js/createAnniversarySelector.js"></script>
    <script src="./common/js/generateFinalImage.js"></script>
    <script src="./common/js/createTextPositionControls.js"></script>
    <script src="./common/js/createPositionControls.js"></script>
    <script src="./common/js/loadImage.js"></script>
    <script src="./common/js/processExcel.js"></script>
    <script src="./common/js/loadExcelFiles.js"></script>
    <script src="./common/js/processExcelFromBuffer.js"></script>
    <script src="./common/js/processExcelData.js"></script>
</body>

</html>